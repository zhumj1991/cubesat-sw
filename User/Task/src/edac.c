#include "edac.h"


const uint8_t code_ham8[256]={0x00, 0x03, 0x05, 0x06, 0x06, 0x05, 0x03, 0x00, 0x07, 0x04, 0x02, 0x01, 0x01, 0x02, 0x04, 0x07,
															0x09, 0x0a, 0x0c, 0x0f, 0x0f, 0x0c, 0x0a, 0x09, 0x0e, 0x0d, 0x0b, 0x08, 0x08, 0x0b, 0x0d, 0x0e,
															0x0a, 0x09, 0x0f, 0x0c, 0x0c, 0x0f, 0x09, 0x0a, 0x0d, 0x0e, 0x08, 0x0b, 0x0b, 0x08, 0x0e, 0x0d,
															0x03, 0x00, 0x06, 0x05, 0x05, 0x06, 0x00, 0x03, 0x04, 0x07, 0x01, 0x02, 0x02, 0x01, 0x07, 0x04,
															0x0b, 0x08, 0x0e, 0x0d, 0x0d, 0x0e, 0x08, 0x0b, 0x0c, 0x0f, 0x09, 0x0a, 0x0a, 0x09, 0x0f, 0x0c,
															0x02, 0x01, 0x07, 0x04, 0x04, 0x07, 0x01, 0x02, 0x05, 0x06, 0x00, 0x03, 0x03, 0x00, 0x06, 0x05,
															0x01, 0x02, 0x04, 0x07, 0x07, 0x04, 0x02, 0x01, 0x06, 0x05, 0x03, 0x00, 0x00, 0x03, 0x05, 0x06,
															0x08, 0x0b, 0x0d, 0x0e, 0x0e, 0x0d, 0x0b, 0x08, 0x0f, 0x0c, 0x0a, 0x09, 0x09, 0x0a, 0x0c, 0x0f,
															0x0c, 0x0f, 0x09, 0x0a, 0x0a, 0x09, 0x0f, 0x0c, 0x0b, 0x08, 0x0e, 0x0d, 0x0d, 0x0e, 0x08, 0x0b,
															0x05, 0x06, 0x00, 0x03, 0x03, 0x00, 0x06, 0x05, 0x02, 0x01, 0x07, 0x04, 0x04, 0x07, 0x01, 0x02,
															0x06, 0x05, 0x03, 0x00, 0x00, 0x03, 0x05, 0x06, 0x01, 0x02, 0x04, 0x07, 0x07, 0x04, 0x02, 0x01,
															0x0f, 0x0c, 0x0a, 0x09, 0x09, 0x0a, 0x0c, 0x0f, 0x08, 0x0b, 0x0d, 0x0e, 0x0e, 0x0d, 0x0b, 0x08,
															0x07, 0x04, 0x02, 0x01, 0x01, 0x02, 0x04, 0x07, 0x00, 0x03, 0x05, 0x06, 0x06, 0x05, 0x03, 0x00,
															0x0e, 0x0d, 0x0b, 0x08, 0x08, 0x0b, 0x0d, 0x0e, 0x09, 0x0a, 0x0c, 0x0f, 0x0f, 0x0c, 0x0a, 0x09,
															0x0d, 0x0e, 0x08, 0x0b, 0x0b, 0x08, 0x0e, 0x0d, 0x0a, 0x09, 0x0f, 0x0c, 0x0c, 0x0f, 0x09, 0x0a,
															0x04, 0x07, 0x01, 0x02, 0x02, 0x01, 0x07, 0x04, 0x03, 0x00, 0x06, 0x05, 0x05, 0x06, 0x00, 0x03};

void edac_byte2ham(uint8_t *check, uint8_t *data)
{
	*check = code_ham8[*data];
}

EdacStatus edac_ham2byte(uint8_t *data, uint8_t *check)
{
	uint8_t temp[4];
	uint8_t syndrome_byte;
	EdacStatus status;
	
	temp[3] = ((*data >> 7) ^ (*data >> 6) ^ (*data >> 5) ^ (*data >> 4) ^ (*check >> 3)) & 0x01;
	temp[2] = ((*data >> 7) ^ (*data >> 3) ^ (*data >> 2) ^ (*data >> 1) ^ (*check >> 2)) & 0x01;
	temp[1] = ((*data >> 6) ^ (*data >> 5) ^ (*data >> 3) ^ (*data >> 2) ^ (*data >> 0) ^ (*check >> 1)) & 0x01;
	temp[0] = ((*data >> 6) ^ (*data >> 4) ^ (*data >> 3) ^ (*data >> 1) ^ (*data >> 0) ^ (*check >> 0)) & 0x01;
	
	syndrome_byte = (temp[3] << 3) | (temp[2] << 2) | (temp[1] << 1) | temp[0];

	if(syndrome_byte == 0)
		status = NO_ERROR;
	else {
		switch(syndrome_byte) {
			case 0x03:
				*data ^= 0x01;
				status = DATA_ERROR;
				break;
			case 0x05:
				*data ^= 0x02;
				status = DATA_ERROR;
				break;
			case 0x06:
				*data ^= 0x04;
				status = DATA_ERROR;
				break;
			case 0x07:
				*data ^= 0x08;
				status = DATA_ERROR;
				break;
			case 0x09:
				*data ^= 0x10;
				status = DATA_ERROR;
				break;
			case 0x0A:
				*data ^= 0x20;
				status = DATA_ERROR;
				break;
			case 0x0B:
				*data ^= 0x40;
				status = DATA_ERROR;
				break;
			case 0x0C:
				*data ^= 0x80;
				status = DATA_ERROR;
				break;

			case 0x01:
				*check ^= 0x01;
				status = CHECK_ERROR;
				break;
			case 0x02:
				*check ^= 0x02;
				status = CHECK_ERROR;;
				break;
			case 0x04:
				*check ^= 0x04;
				status = CHECK_ERROR;
				break;
			case 0x08:
				*check ^= 0x08;
				status = CHECK_ERROR;
				break;

			default :
				status = ERRORS;
				break;
		}
	}

	return status;
}


int8_t edac_generate(uint8_t *check_buf, uint8_t *data_buf, uint32_t size)
{
	uint8_t * p_check = check_buf;
	uint8_t * p_data = data_buf;
	
	while(size--)
	{
		edac_byte2ham(p_check++, p_data++);
	}
	
	return 0;
}

int8_t edac_check(uint8_t *data_buf, uint8_t *check_buf, uint32_t size)
{
	uint8_t temp;
	uint8_t * p_check = check_buf;
	uint8_t * p_data = data_buf;
	EdacStatus status;
	
	while(size--)
	{
		edac_byte2ham(&temp, p_data);
		
		if(temp != *p_check)
		{		
			status = edac_ham2byte(p_data, p_check);
		
			if(status == ERRORS)
			{
				return -1;
			}
		}
		
		p_data++;
		p_check++;
	}
	
	return 0;
}
